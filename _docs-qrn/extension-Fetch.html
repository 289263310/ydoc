<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge, chrome=1">
  <meta name="description" content="description of your site">
  <meta name="author" content="author of the site">
  <title>Qunar React Native EXT</title>
  <link rel="stylesheet" href="source/app.css"/>
  <link rel="stylesheet" href="source/highlight.min.css"/>
</head>
<body>
    <div class="ydoc">
      <header class="ydoc-header">
        <div class="ydoc-header-area">
            
            <button class="ydocIcon navbar-toggle">&#xf020;</button>
            <nav class="ydoc-nav">
              <ul class="navbar-left">
                
                    
                    <li class="">
                        
                        <a href="index.html">开始</a>
                        
                    </li>
                    
                    <li class="">
                        
                        <a href="component.html">组件</a>
                        
                    </li>
                    
                    <li class="">
                        
                        <a href="extraUI.html">外部组件</a>
                        
                    </li>
                    
                    <li class="">
                        
                        <a href="api.html">API</a>
                        
                    </li>
                    
                    <li class="active">
                        
                        <a href="extension.html">EXT</a>
                        
                    </li>
                    
                    <li class="">
                        
                        <a href="extending.html">扩展</a>
                        
                    </li>
                    
                    <li class="">
                        
                        <a href="demo.html">DEMO</a>
                        
                    </li>
                    
                    <li class="">
                        
                        <a href="faq.html">FAQ</a>
                        
                    </li>
                    
                    <li class="">
                        
                        <a href="releases.html">Releases</a>
                        
                    </li>
                    
                    <li class="">
                        
                        <a href="http://ued.qunar.com/react-web/" target="_blank">React Web</a>
                        
                    </li>
                    
                
              </ul>
            </nav>
        </div>
    </header>
    
    <!-- <header style="height:20px"></header> -->
    
      <!-- Docs page layout -->
      
      <div class="ydoc-banner-bg">
          <div class="ydoc-banner">
              <div class="ydoc-banner-area">
                  <h1>Qunar React Native Extension</h1>
                  <p>Qunar React Native 增强拓展框架</p>
              </div>
          </div>
      

      <div class="ydoc-container">
        
          
          <div class="ydoc-container-content">
              <div class="content-left" role="complementary">
                  <nav class="docs-sidebar hidden-print hidden-xs hidden-sm">
                    <ul class="nav docs-sidenav">
                        
                        
                        <!-- <li  > -->
                        <li >
                            
                            <a href="extension-Router.html">Router</a>
                            
                        </li>
                        
                        
                        
                        <!-- <li  > -->
                        <li >
                            
                            <a href="extension-WebX.html">WebX</a>
                            
                        </li>
                        
                        
                        
                        <!-- <li  > -->
                        <li >
                            
                            <a href="extension-Redux.html">Redux</a>
                            
                        </li>
                        
                        
                        
                        <!-- <li  class="active"   class="active" > -->
                        <li  class="active" >
                            
                            <a href="extension-Fetch.html">Fetch</a>
                            
                        </li>
                        
                        
                    </ul>
                  </nav>
              </div>
              <div class="content-right markdown-body" role="main">

                
                <h1 id="Fetch - Ext Plugin">Fetch - Ext Plugin</h1><h2 id="简介">简介</h2><p>基于原生 <code>fetch</code> 方法提供了便于用户使用的封装，提供了中间件、抽象请求等一系列便于用户使用的方式。</p>
<h2 id="使用">使用</h2><p>fetch 是一个独立插件，需要单独安装。安装方式：</p>
<pre><code class="lang-js">npm install @qnpm/react-native-ext-fetch --save --registry=http://registry.npm.corp.qunar.com/
</code></pre>
<p>之后在项目中引用一下即可：</p>
<pre><code class="lang-js">import &#39;@qnpm/react-native-ext-fetch&#39;

// 也可以用这种方式
import cf from &#39;@qnpm/react-native-ext-fetch&#39;
</code></pre>
<p>之所以不叫 <code>fetch</code> 是为了和 RN 实现的原生 fetch 方法进行区分。</p>
<p>基本与 <code>fetch</code> 的行为相同，传入参数并返回一个 Promise 对象。使用中有微小的区别在于：</p>
<ol>
<li>原生的 <code>fetch</code> 方法，第一个参数要么为 url，要么为 Request 对象。这里我们允许只传递一个配置项，将 url 放入 <code>url</code> 参数中即可。</li>
<li>统一使用 <code>body</code> 字段进行参数传递。在原生的 <code>fetch</code> 方法中，是不允许用户给 GET/HEADER 这两种没有请求体的请求传入 <code>body</code> 字段的，但这里为了方便使用，我们允许传入并进行正常解析。</li>
<li>自动解析响应头的 <code>Content-Type</code> 字段，解析响应格式，目前仅支持 json。</li>
</ol>
<pre><code class="lang-js">const f = React.Ext.utils.fetch;
let param = {
    page: 1,
    pageSize: 10
}

f({
    url: &#39;/api/query&#39;,
    body: param
});

// 对比原生 fetch 的方法
fetch(`/api/query?page=${param.page}&amp;pageSize=${param.pageSize}`);
</code></pre>
<h2 id="增强">增强</h2><h3 id="requestType 与 responseType">requestType 与 responseType</h3><p>支持用户传入 <code>requestType</code> 和 <code>responseType</code> 字段，前者表示请求体的格式，后者表示响应体的格式，分别会修改请求首部字段的 Content-Type 与 Accept。</p>
<p>这里我们根据 <code>requestType</code> 字段自动对用户传入的 body 进行转换，目前仅支持 json 和 x-www-form-urlencoded，分别对应 <code>&#39;json&#39;</code> 和 <code>&#39;form&#39;</code>。</p>
<p>我们还根据 <code>responseType</code> 的设定来解析响应体，它的优先级高于自动检测响应体的 Content-Type。目前仅支持 json，如果不是 json 则返回 response 对象。</p>
<p>这里的 body 可以直接传入普通对象，fetch 方法会自动进行 <code>JSON.stringify</code> 之类的转换。</p>
<h3 id="cache false">cache false</h3><p>支持便捷设置 cache false，等于给 headers 设定 Cache-Control: no-cache。</p>
<h3 id="中间件">中间件</h3><p>支持传入一些统一处理请求数据和响应数据的中间件，中间件直接对数据对象进行操作，中间如果抛出异常，或者返回一个异常，都会被捕获，并以此为原因 reject 掉本 fetch。</p>
<pre><code class="lang-js">const f = React.Ext.utils.fetch;

// 中间件：统一处理请求参数
f.request(req =&gt; req.url = `http://uedx.qunar.com/api${req.url}`);
// 中间件：统一处理响应解决，抛出异常
f.response(res =&gt; {
    if (!res.ret) {
        throw new Error(res.errmsg || &#39;请求错误&#39;);
    }
});

f(...).then(...).catch(...)
</code></pre>
<h3 id="redux 增强">redux 增强</h3><p>redux 默认支持 promise 的中间件，当 <code>action.payload</code> 参数为 promise 对象时，<code>dispatch</code> 方法返回改 promise，且在 promise then 之后执行 <code>dispatch</code> 方法。如果该 promise 被解决，将解决的值赋给 <code>action.payload</code>；如果被拒绝，将拒绝原因赋值给 <code>action.payload</code>，使 <code>action.error = true</code>。</p>
<h3 id="promise 增强">promise 增强</h3><p>为原生 promise 补充 <code>done</code>, <code>fail</code> 和 <code>always</code> 等常用方式。</p>
<h3 id="abort 支持">abort 支持</h3><p>对 <code>fetch</code> 添加 <code>cancel</code> 方法。具体使用如下：</p>
<pre><code class="lang-js">const cf = Ext.utils.fetch;
const def = cf(&#39;http://hello.world.com&#39;);

def.then(res =&gt; {
    // ...do something
}).catch(err =&gt; {
    // cancel 时会进到 catch 中，cancel 传的内容就是 catch 的参数
    // 比如下面的 cancel 之后，err 就是 123
});

def.cancel(123);
</code></pre>
<p><strong>注意</strong>：仅 fetch 返回的 promise 拥有 <code>cancel</code> 方法！下面的调用就是错误的：</p>
<pre><code class="lang-js">const cf = Ext.utils.fetch;
const def = cf(&#39;http://hello.world.com&#39;)
    .then(res =&gt; {
        // ...do something
    }).catch(err =&gt; {
        // cancel 时会进到 catch 中，cancel 传的内容就是 catch 的参数
        // 比如下面的 cancel 之后，err 就是 123
    });

def.cancel(123);
</code></pre>
<h3 id="timeout 支持">timeout 支持</h3><p>支持传入 timeout 时间，已毫秒为单位：</p>
<pre><code class="lang-js">const cf = Ext.utils.fetch;

cf(&#39;http://hello.world.com&#39;, { timeout: 1000 })
    .catch(err =&gt; alert(err)); // 如果请求超时，err 是 TypeError(&#39;Network request timeout&#39;)
</code></pre>

              </div>
          </div>
          
        
      </div>
     
     </div>
     
      <footer class="footer">
        <div class="copyright">
            © 2015 - 2016 Qunar 平台前端架构组. Powered by <a href="http://gitlab.corp.qunar.com/mfe/qdoc">qdoc</a>
        </div>
      </footer>
    </div>
    <script src="source/jquery.min.js"></script>
    <script src="source/bootstrap.min.js"></script>
    <script src="source/docs.min.js"></script>
    <script src="source/highlight.min.js"></script>
    <script src="source/app.js"></script>
</body>
</html>
