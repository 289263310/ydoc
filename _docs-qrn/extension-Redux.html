<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge, chrome=1">
  <meta name="description" content="description of your site">
  <meta name="author" content="author of the site">
  <title>Qunar React Native EXT</title>
  <link rel="stylesheet" href="source/app.css"/>
  <link rel="stylesheet" href="source/highlight.min.css"/>
</head>
<body>
    <div class="ydoc">

      <header class="ydoc-header">
        <div class="ydoc-header-area">
            
            <a href="http://ued.qunar.com/mobile/" class="navbar-brand">Qunar MFE</a>
            
            <button class="ydocIcon navbar-toggle">&#xf020;</button>
            <nav class="ydoc-nav">
              <ul class="navbar-left">
                
                    
                    <li class="">
                        
                        <a href="index.html">开始</a>
                        
                    </li>
                    
                    <li class="">
                        
                        <a href="component.html">组件</a>
                        
                    </li>
                    
                    <li class="">
                        
                        <a href="extraUI.html">外部组件</a>
                        
                    </li>
                    
                    <li class="">
                        
                        <a href="api.html">API</a>
                        
                    </li>
                    
                    <li class="active">
                        
                        <a href="extension.html">EXT</a>
                        
                    </li>
                    
                    <li class="">
                        
                        <a href="extending.html">扩展</a>
                        
                    </li>
                    
                    <li class="">
                        
                        <a href="demo.html">DEMO</a>
                        
                    </li>
                    
                    <li class="">
                        
                        <a href="faq.html">FAQ</a>
                        
                    </li>
                    
                    <li class="">
                        
                        <a href="releases.html">Releases</a>
                        
                    </li>
                    
                    <li class="">
                        
                        <a href="http://ued.qunar.com/react-web/" target="_blank">React Web</a>
                        
                    </li>
                    
                
              </ul>
            </nav>
        </div>
    </header>
    
    <!-- <header style="height:20px"></header> -->
    
      <!-- Docs page layout -->
      
      <div class="ydoc-banner">
          <div class="ydoc-banner-area">
              <h1>Qunar React Native Extension</h1>
              <p>Qunar React Native 增强拓展框架</p>
          </div>
      </div>
      




      <div class="ydoc-container">
        
          
          <div class="ydoc-container-content">
              <div class="content-right">
                  <nav class="sidebar">
                    <ul class="nav docs-sidenav">
                        
                        
                        <li>
                            
                            <a href="extension-Router.html" >Router</a>
                            
                        </li>
                        
                        
                        
                        <li>
                            
                            <a href="extension-WebX.html" >WebX</a>
                            
                        </li>
                        
                        
                        
                        <li>
                            
                            <a href="extension-Redux.html" style="color:#0088a4">Redux</a>
                            
                        </li>
                        
                        
                        
                        
                        <ul class="docs-sidenav-extend">
                        
                            <li>
                                <a href="#内容更新" >内容更新</a>
                            </li>
                        
                        
                        
                        
                        
                            <li>
                                <a href="#基本概念" >基本概念</a>
                            </li>
                        
                        
                        
                        
                        
                            <li>
                                <a href="#使用方式" >使用方式</a>
                            </li>
                        
                        </ul>
                        
                        
                        
                        
                        <li>
                            
                            <a href="extension-Fetch.html" >Fetch</a>
                            
                        </li>
                        
                        
                    </ul>
                  </nav>
              </div>
              <div class="content-left markdown-body">
                
                <h1 id="Redux - Ext Plugin">Redux - Ext Plugin</h1><h2 id="内容更新">内容更新</h2><p>插件提供了 redux 数据管理的支持，相比之前的老版本提供了一些更新和用法改进。</p>
<ol>
<li>相比之前版本的一个 view 一个 store，本版本提供单一 store 的数据管理方式，使得页面之前可以进行数据的共享。如果部分页面需要使用独立的 store，本版本还在 router 上进行了适配，可以直接使用 <code>Ext.open(&#39;pageName:new&#39;)</code> 的方式，开启拥有独立 store 的页面。</li>
<li>简化了 store 的配置方式，之前还需要使用 <code>defineStore</code> 来处理，现在只需要配置 <code>Ext.defaults.redux</code> 属性即可。</li>
<li>与之前 QView 无法使用 <code>reduxPlugin</code> 不同，本版本在 QView 和 QComponent 下都可以指定 <code>mapStateToProps</code> 和 <code>mapDispatchToProps</code>，获取和调度 store 中的数据。即使是拥有独立 store 的 QView 页面也可以进行 <code>reduxPlugin</code> 的配置。</li>
<li>需要注意的一点是，使用 <code>Ext.open</code> 打开的页面，在对应的 QView 组件上会有名为 <code>param</code> 的属性，表示页面参数。正常情况下，QView 内部的 QComponent 组件可以在 <a href="https://facebook.github.io/react/docs/context.html">context</a> 上获取，但如果本组件拥有 <code>reduxPlugin</code>，插件会帮你把 <code>param</code> 参数挂载到 <code>props</code> 上。</li>
</ol>
<h2 id="基本概念">基本概念</h2><p>关于 redux 插件，摒弃了 redux 之前复杂的概念，有三个最基本的概念：</p>
<ol>
<li><strong>store</strong>：store 是数据存储的地方，整个应用的数据存在在 store 之中，状态树的设计尤为重要。</li>
<li><strong>action</strong>：整个 redux 其实还是可以理解成发布/订阅模式，action 就是这个模式的<strong>发布</strong>方法，用户只能通过 action 来触发数据变化，是改变 store 的唯一手段。在官方版本中，action 是通过 <code>dispatch</code> （调度器）来触发的；而在我们的插件中，我们对 <code>mapDispatchToProps</code> 方法做了简化，很大程度上隐藏了这一概念。</li>
<li><p><strong>reducer</strong>：reducer 是 store 的组成部分。如果说 store 是一棵状态树，reducer 就是树枝，众多 reducer 最终通过 <code>combineReducers</code> 方法汇成最终的 store。</p>
<p> <img src="http://7xinjg.com1.z0.glb.clouddn.com/combined-redux.png" alt="combined-redux"></p>
<p> reducer 本身承担了模式的<strong>调度</strong>。事实上在 reducer 中我们还需要处理 action 触发后如何修改 store 中状态树的逻辑。</p>
</li>
</ol>
<h2 id="使用方式">使用方式</h2><h3 id="配置方式">配置方式</h3><p>提供了配置 redux 的快捷方式，不需要配置原生的 <code>createStore</code> 和 <code>applyMiddleware</code> 等复杂概念，只需要在 <code>Ext.defaults.redux</code> 中配置两个简单的属性即可。</p>
<pre><code>// redux 配置项
Ext.defaults.redux = {
    /**
     * 配置 createStore 的三个参数 reducer/initialState/enhancer
     */
    reducer,
    initialState,
    enhancer
    /**
     * 配置 middleware 中间件
     */
    middleware: []
};
</code></pre><p>这些参数里面只有 reducer 是必填的，用于初始创建 store。</p>
<p>版本内置了两个著名的中间件：<a href="https://github.com/gaearon/redux-thunk">redux-thunk</a> 和 <a href="https://github.com/acdlite/redux-promise">redux-promise</a>。由于 promise 中间件会<strong>阻断</strong>中间件的执行，因此这两个内置中间件都被放在用户自定义中间件之后执行。</p>
<h3 id="对外提供方法">对外提供方法</h3><p><code>Ext.Redux</code> 对外提供的最主要方法是：<code>combineReducers</code> 和 <code>bindActionCreators</code>。其中最最重要的是前者，在一个项目中必定会使用到。<code>combineReducers</code> 是连接 reducer 的手段，将独立的 reducer 拼合成项目的 state 树。<code>bindActionCreators</code> 如果不是对 actions creator 有特殊要求，可以通过写简写的方式避免其使用。可参加下文的<strong>组件使用方式</strong>。</p>
<h3 id="action 编写方式">action 编写方式</h3><p>action 是一个返回固定格式对象的纯函数。其编写示例如下所示：</p>
<pre><code>export function switchCategory(categoryId) {
    return {
        type: types.SWITCH_CATEGORY,
        payload: categoryId
    }
}
</code></pre><p>其返回的对象应遵循 flux action <a href="https://github.com/acdlite/flux-standard-action">标准规范</a>，必须包含 <code>type</code> 属性，数据建议存放至 <code>payload</code> 属性。其中 <code>type</code> 属性建议使用字符常量或 Symbol 来进行定义。</p>
<h3 id="reducer 编写方式">reducer 编写方式</h3><p>reducer 是一个返回部分状态的纯函数，支持传入两个参数：<code>state</code>、<code>action</code>。其中设置 <code>initialState</code> 作为初始值传递给 <code>state</code>，返回的状态必须是<strong>整个</strong> reducer 包含的 state，建议使用 ES6 的<a href="http://es6.ruanyifeng.com/#docs/object#对象的扩展运算符">扩展运算符</a>来确保返回 state 的完整性。</p>
<pre><code>const initialState = {
    list: [],
    info: {}
};

export default (state = initialState, action) =&gt; {
    switch (action.type) {
        case types.FETCH_SHOP_LIST:
            return {
                // 确保对象的完整性
                ...state,
                list: action.payload.data.shopList
            };
            break;
        case types.FETCH_SHOP_INFO:
            return {
                ...state,
                info: action.payload.data
            };
        default:
            // 无论什么情况下，该函数都要确保返回一个 state
            return state;
    }
}
</code></pre><p>多个 reducer 之间可以通过 <code>combineReducers</code> 进行连接：</p>
<pre><code>export default combineReducers({
    shopList,
    price,
    shopInfo: combineReducers({ shopDetail, foodInfo })
})
</code></pre><h3 id="组件使用方式">组件使用方式</h3><p>redux 插件在 QView 和 QComponent 中的使用方式完全一致。给组件添加一个<strong>静态方法</strong> <code>reduxPlugin</code> 即可，里面可以提供四个参数，分别为 <code>mapStateToProps</code>、<code>mapDispatchToProps</code>、<code>mergeProps</code>、<code>options</code>，其中业务中最常见的是前两个参数：</p>
<ol>
<li><code>mapStateToProps(state, [ownProps])</code>：如果定义该参数，组件将会监听 store 的变化，发生改变时改变组件中对应的 props 的值。如果没有设置这个参数，组件将<strong>不会</strong>监听 store：即在 store 发生变化时，组件将不会收到任何响应和更新。</li>
<li><code>mapDispatchToProps(dispatch, [ownProps])</code>：如果定义该参数，等于给组件的 props 上挂载对应的 <a href="http://cn.redux.js.org/docs/Glossary.html#action-creator">Action Creator</a>。这只是一个便捷用法，如果不使用，还是可以使用 <code>dispatch</code> 来触发 store 更新。</li>
</ol>
<p>剩下两个参数和其余高级用法可以参见 <a href="http://cn.redux.js.org/docs/react-redux/api.html">react-redux/api</a>。</p>
<pre><code>import { changeFoodCount } from &#39;./actions&#39;
const { bindActionCreators } = Ext.Redux;

static reduxPlugin = {
    // mapStateToProps 官方正常使用
    mapStateToProps: (state) =&gt; ({
        shopList: state.shopList
        category: state.shopInfo.category
    }),
    // 插件支持的便捷用法，直接传入数组，效果和上面一样
    mapStateToProps: [&#39;shopList&#39;, &#39;shopInfo.category&#39;],

    // mapDispatchToProps 官方正常使用
    mapDispatchToProps: (dispatch) =&gt; ({
        changeFoodCount: bindActionCreators(changeFoodCount, dispatch)
    }),
    // 插件支持的便捷用法，直接传入对象，效果和上面一样
    mapDispatchToProps: { changeFoodCount }
};
</code></pre><p>需要注意的是，redux 内部对属性进行<strong>变化检测</strong>的时候，用的是<strong>浅对比</strong>，即上文中，如果仅对原先的 <code>shopList</code>和 <code>category</code> 对象进行 <code>===</code> 比较，不会深入分析内部变化。因此如果进行对象属性改变，务必进行新对象的创建，或直接使用 <a href="https://github.com/facebook/immutable-js">immutable</a>。</p>

              </div>
          </div>
          
        
      </div>

      <footer class="footer">
        <div class="copyright">
            © 2015 - 2016 Qunar 平台前端架构组. Powered by <a href="http://gitlab.corp.qunar.com/mfe/qdoc">qdoc</a>
        </div>
      </footer>
    </div>
    <script src="source/jquery.min.js"></script>
    <script src="source/highlight.min.js"></script>
    <script src="source/app.js"></script>
</body>
</html>
